name: Delete Preview

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  delete-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Get branch name and sanitize
        id: branch
        run: |
          # Get the branch name from the PR
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          # Replace / with - and convert to lowercase
          SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/\//-/g' | tr '[:upper:]' '[:lower:]')
          echo "sanitized=$SANITIZED_BRANCH" >> $GITHUB_OUTPUT
          echo "Worker name to delete: ${{ github.event.repository.name }}-$SANITIZED_BRANCH"

      - name: Delete Cloudflare Workers preview environment
        run: |
          # Delete the preview worker (worker name is based on branch name)
          WORKER_NAME="${{ github.event.repository.name }}-${{ steps.branch.outputs.sanitized }}"
          curl -X DELETE "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/workers/scripts/$WORKER_NAME?force=true" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json"

          echo "Deleted preview worker: $WORKER_NAME"
